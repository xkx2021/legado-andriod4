---
name: Android 4.4 Build with APK Signing

on:
  push:
    branches:
      - master
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-android44-release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up JDK 8
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: 8

      - name: Set up Gradle 7.4
        uses: gradle/gradle-build-action@v2
        with:
          gradle-version: '7.4'

      - name: Set up Android SDK manually
        run: |
          echo "=== Setting up Android SDK with Java 8 compatible tools ==="
          # Set ANDROID_HOME
          export ANDROID_HOME=$HOME/android-sdk
          echo "ANDROID_HOME=$ANDROID_HOME" >> $GITHUB_ENV
          echo "$ANDROID_HOME/build-tools/30.0.2" >> $GITHUB_PATH
          echo "$ANDROID_HOME/platform-tools" >> $GITHUB_PATH
          # Create Android SDK directory
          mkdir -p $ANDROID_HOME
          # Download and extract Java 8 compatible cmdline-tools (version 8.0)
          URL="https://dl.google.com/android/repository/commandlinetools-linux-8512546_latest.zip"
          wget -q "$URL" -O cmdline-tools.zip
          mkdir -p $ANDROID_HOME/cmdline-tools
          unzip -q cmdline-tools.zip -d $ANDROID_HOME/cmdline-tools
          # Move cmdline-tools to versioned directory
          SRC_DIR="$ANDROID_HOME/cmdline-tools/cmdline-tools"
          DST_DIR="$ANDROID_HOME/cmdline-tools/8.0"
          mv "$SRC_DIR" "$DST_DIR"
          rm cmdline-tools.zip
          # Create license files to accept licenses
          mkdir -p $ANDROID_HOME/licenses
          SDK_LICENSE="8933bad161af4178b1185d1a37fbf41ea5269c55"
          PREVIEW_LICENSE="d975f751698a77b662f1254ddbeed3901e976f5a"
          # Write licenses to files
          LICENSE_FILE="$ANDROID_HOME/licenses/android-sdk-license"
          echo "$SDK_LICENSE" > "$LICENSE_FILE"
          PREVIEW_FILE="$ANDROID_HOME/licenses/android-sdk-preview-license"
          echo "$PREVIEW_LICENSE" > "$PREVIEW_FILE"
          # Install necessary SDK components
          SDKMANAGER="$ANDROID_HOME/cmdline-tools/8.0/bin/sdkmanager"
          # Accept licenses first
          yes | $SDKMANAGER --sdk_root=$ANDROID_HOME --licenses || true
          $SDKMANAGER --sdk_root=$ANDROID_HOME \
            "platform-tools" \
            "build-tools;30.0.2" \
            "platforms;android-31" \
            "platforms;android-23" \
            --verbose

      - name: Build Release APK with Gradle 7.4
        run: |
          echo "开始构建Android 4.4兼容版本Release APK"
          # 调试：检查构建环境
          echo "=== 构建环境调试信息 ==="
          echo "当前目录: $(pwd)"
          echo "PATH: $PATH"
          echo "HOME: $HOME"
          
          # 检查是否有系统级Gradle
          if which gradle; then
            echo "系统Gradle版本: $(gradle --version)"
          else
            echo "没有找到系统级Gradle"
          fi
          
          # 检查gradle-build-action安装的Gradle
          echo "=== Gradle Build Action 安装的Gradle ==="
          ls -la /opt/gradle/ 2>/dev/null || echo "没有找到 /opt/gradle/ 目录"
          
          # 检查gradle-wrapper.properties配置
          echo "=== gradle-wrapper.properties 配置 ==="
          cat gradle/wrapper/gradle-wrapper.properties
          
          # 确保gradlew有执行权限
          chmod +x gradlew
          
          # 检查gradlew脚本内容（前50行）
          echo "=== gradlew 脚本开头部分 ==="
          head -50 gradlew
          
          # 检查Gradle版本
          echo "=== 执行 gradle --version ==="
          gradle --version
          
          # 使用--no-configuration-cache避免配置缓存问题
          gradle assembleRelease --no-daemon --warning-mode all --no-configuration-cache

      - name: Sign Release APK
        run: |
          echo "开始签名Release APK"
          # Use existing keystore
          KS_FILE=".github/workflows/legado.jks"
          KS_PASSWORD="123456"
          KEY_ALIAS="legado"
          KEY_PASSWORD="123456"
          # Get path to apksigner
          APKSIGNER="$ANDROID_HOME/build-tools/30.0.2/apksigner"
          # Find unsigned APK
          UNSIGNED_APK=$(find app/build/outputs/apk/release \
            -name "*.apk" \
            | grep -v "signed")
          if [ -z "$UNSIGNED_APK" ]; then
            echo "No unsigned APK found"
            exit 1
          fi
          # Sign the APK
          echo "Signing APK: $UNSIGNED_APK"
          $APKSIGNER sign \
            --ks "$KS_FILE" \
            --ks-pass pass:"$KS_PASSWORD" \
            --key-pass pass:"$KEY_PASSWORD" \
            --v1-signing-enabled true \
            --v2-signing-enabled true \
            "$UNSIGNED_APK"
          # Verify signature
          echo "Verifying signature..."
          $APKSIGNER verify --verbose "$UNSIGNED_APK"
          echo "APK signing completed successfully"

      - name: Upload Signed Release APK
        uses: actions/upload-artifact@v4
        with:
          name: legado.android44.signed.release
          path: app/build/outputs/apk/release/*.apk
